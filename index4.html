<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Debug de Inventario: Flujo Autom치tico con Retraso</title>
<style>
/* Estilos CSS para la pantalla de carga */
body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column; 
    align-items: center;
    justify-content: center;
    background-color: #333; /* Fondo oscuro */
    color: white;
    transition: opacity 0.5s ease-in-out;
}
#loading-overlay {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    z-index: 10000;
    padding-bottom: 20px;
}
#loading-overlay h1 {
    font-size: 2em;
    margin-bottom: 20px;
}
.spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #fff;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin-top: 15px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Estilos para el panel de Debug: SCROLL HABILITADO */
#debug-log {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    max-height: 30vh;
    overflow-y: scroll; /* Scroll vertical */
    background-color: #222;
    border-top: 2px solid #555;
    padding: 10px;
    box-sizing: border-box;
    font-family: 'Courier New', monospace;
    font-size: 0.8em;
    color: #00ff44; /* Verde brillante para debug */
    z-index: 10001;
    white-space: pre-wrap;
}
.log-entry {
    border-bottom: 1px dashed #444;
    padding: 4px 0;
    word-wrap: break-word; 
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.log-url-text {
    flex-grow: 1;
}
.redirect-button {
    background-color: #007bff; /* Azul para la acci칩n de b칰squeda */
    color: white;
    border: none;
    padding: 4px 8px;
    margin-left: 10px;
    cursor: pointer;
    font-size: 0.7em;
    border-radius: 3px;
    flex-shrink: 0;
}
.redirect-button:hover {
    background-color: #0056b3;
}
.json-response {
    color: #ffcc00; /* Color naranja para el JSON */
    white-space: pre-wrap;
    padding: 5px 0;
    border-top: 1px dotted #444;
    margin-top: 5px;
}
.ad-url-analysis {
    color: #44ccff; /* Color celeste para el an치lisis de URL */
    white-space: pre-wrap;
    padding: 5px 0;
    border-top: 1px dotted #444;
    margin-top: 5px;
}
</style>
</head>
<body>
    <div id="loading-overlay">
        <h1 id="loading-status">Buscando Inventario...</h1>
        <div class="spinner"></div>
        <p id="loading-message">INICIO: Esperando la primera respuesta del servidor de PopAds.</p>
    </div>

    <div id="debug-log">
        <strong>[ DEBUG LOG ] (Scroll Habilitado. El inventario principal se abre autom치ticamente, espera 20s y busca de nuevo. El Fallback usa el bot칩n.)</strong>
    </div>

    <center><iframe src="https://sefsdvc.com/en/us/media/dynamic/id?zid=11922&pid=0&custom1=&custom2=60670&custom3=%7Btransaction_id%7D&custom6=&custom7=PUB_381468&cturl=https://t.irtyf.com/ihxg01j1ds?file_id=252623&aff_id=381468&offer_id=3788&aff_sub=&url=" width="300" height="250" scrolling="no" frameBorder="0"></iframe></center>

<script>
(function(window, document, screen) {
    // Definiciones y polyfills
    Function.prototype.bind || (Function.prototype.bind = function(thisArg) {
        if (typeof this !== "function") { throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable"); }
        var args = Array.prototype.slice.call(arguments, 1);
        var self = this;
        var noOp = function() {};
        var bound = function() { return self.apply(this instanceof noOp && thisArg ? this : thisArg, args.concat(Array.prototype.slice.call(arguments))); };
        noOp.prototype = this.prototype;
        bound.prototype = new noOp;
        return bound;
    });

    var debugLogElement = document.getElementById('debug-log');
    var loadingStatusElement = document.getElementById('loading-status');
    var loadingMessageElement = document.getElementById('loading-message');

    // Constantes y variables de control
    const RETRY_INTERVAL = 20000; // 20 segundos (Para el reintento autom치tico por falta de inventario)
    const AUTO_RETRY_DELAY = 20000; // 20 segundos (游띔 NUEVA: Retraso entre URL abierta y nueva b칰squeda)
    let retryTimeout = null; 
    let urlCounter = 0; 

    function updateLoadingStatus(status, message, isSuccess) {
        // 1. Actualizar el overlay visible
        loadingStatusElement.innerHTML = status;
        loadingMessageElement.innerHTML = message;
        
        var spinner = document.querySelector('.spinner');
        if (spinner) {
            if (isSuccess === true) {
                spinner.style.display = 'block';
                loadingStatusElement.style.color = '#85ff85'; 
            } else if (isSuccess === false) {
                spinner.style.display = 'none'; 
                loadingStatusElement.style.color = '#ff4444'; 
            } else {
                spinner.style.display = 'block';
                loadingStatusElement.style.color = 'white';
            }
        }

        // 2. Registrar el mensaje en el panel de debug (solo si no es una entrada de bot칩n)
        if (!status.includes('URL DETECTADA')) {
            var timestamp = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            var logMessage = '[' + timestamp + '] (' + status + ') :: ' + message;
            
            var entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = logMessage;
            
            debugLogElement.insertBefore(entry, debugLogElement.children[1]); 
        }
        
        // 3. Mantener un l칤mite de entradas (incluyendo las de JSON)
        while (debugLogElement.children.length > 20) {
            debugLogElement.removeChild(debugLogElement.lastChild);
        }
    }

    /**
     * Agrega el JSON de respuesta completo al log (Respuesta del Inventario).
     * @param {object} inventoryData El objeto JSON sin procesar.
     */
    function addJsonResponseToLog(inventoryData) {
        const timestamp = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        
        const jsonString = JSON.stringify(inventoryData, null, 2); 

        const entry = document.createElement('div');
        entry.className = 'log-entry';

        const header = document.createElement('span');
        header.textContent = `[${timestamp}] (RESPUESTA SERVIDOR) :: JSON de Inventario Completo:`;
        
        const jsonPre = document.createElement('pre');
        jsonPre.className = 'json-response';
        jsonPre.textContent = jsonString;

        entry.appendChild(header);
        entry.appendChild(jsonPre);
        
        debugLogElement.insertBefore(entry, debugLogElement.children[1]); 

        updateLoadingStatus('JSON CAPTURADO', 'Respuesta JSON del servidor registrada en el debug.', true);
    }
    
    /**
     * Intenta leer el contenido de la URL de Anuncio.
     * @param {string} url La URL de anuncio a ser analizada.
     */
    function addAdUrlAnalysisToLog(url, entryToUpdate) {
        const timestamp = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit', second:'2-digit'});

        let entry = entryToUpdate;
        if (!entry) {
             entry = document.createElement('div');
             entry.className = 'log-entry';
             const header = document.createElement('span');
             header.textContent = `[${timestamp}] (AN츼LISIS URL ANUNCIO) :: Iniciando intento de lectura de la URL de Ad:`;
             entry.appendChild(header);
             debugLogElement.insertBefore(entry, debugLogElement.children[1]); 
        }

        // Usamos una URL de Proxy para intentar saltar CORS. Si no tienes uno, esto fallar치.
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`; 
        
        // 1. Mostrar el intento en el log
        let analysisPre = entry.querySelector('.ad-url-analysis');
        if (!analysisPre) {
            analysisPre = document.createElement('pre');
            analysisPre.className = 'ad-url-analysis';
            entry.appendChild(analysisPre);
        }
        analysisPre.textContent = `Intentando leer contenido de: ${url}\n(Usando proxy: ${proxyUrl})`;
        
        // 2. Ejecutar la llamada (usando 'fetch' para simular la petici칩n)
        fetch(proxyUrl, { method: 'GET' })
            .then(response => {
                const contentType = response.headers.get('content-type');
                if (response.ok) {
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(json => {
                            updateAdAnalysisLog(entry, `JSON ANUNCIO RECIBIDO. Content-Type: ${contentType}\n${JSON.stringify(json, null, 2)}`);
                        }).catch(e => {
                            return response.text().then(text => {
                                 updateAdAnalysisLog(entry, `ERROR al parsear JSON (Type: ${contentType}). Mostrando Texto crudo:\n${text}`);
                            });
                        });
                    } else if (response.redirected) {
                        updateAdAnalysisLog(entry, `REDIRECCI칍N DETECTADA. URL Final: ${response.url}`);
                    } else {
                        return response.text().then(text => {
                            updateAdAnalysisLog(entry, `TEXTO/HTML RECIBIDO. Content-Type: ${contentType}. Inicio del contenido:\n${text.substring(0, 500)}...`);
                        });
                    }
                } else {
                    updateAdAnalysisLog(entry, `[ERROR HTTP ${response.status}] No se pudo leer la URL de Anuncio. El navegador abrir치: ${url}`);
                }
            })
            .catch(error => {
                updateAdAnalysisLog(entry, `[ERROR CORS/FETCH] No se pudo leer la URL de Anuncio directamente. El navegador abrir치: ${url}`);
            });
    }

    /**
     * Funci칩n auxiliar para actualizar la entrada de log de an치lisis de URL.
     */
    function updateAdAnalysisLog(entry, content) {
        const analysisPre = entry.querySelector('.ad-url-analysis');
        if (analysisPre) {
            analysisPre.textContent = content;
        }
    }
    
    /**
     * Agrega una entrada al log que incluye un bot칩n de redirecci칩n (SOLO PARA FALLBACK).
     */
    function addRedirectButtonToLog(source, url, bid) {
        urlCounter++;
        
        const timestamp = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        const truncatedUrl = url.length > 70 ? url.substring(0, 67) + '...' : url;

        const entry = document.createElement('div');
        entry.className = 'log-entry';

        const textSpan = document.createElement('span');
        textSpan.className = 'log-url-text';
        textSpan.textContent = `[${timestamp}] (URL DETECTADA: ${source}), Bid: ${bid}) :: ${truncatedUrl}`;

        const button = document.createElement('button');
        button.className = 'redirect-button';
        button.textContent = 'Analizar & Redirigir (Manual)'; 
        
        // L칩gica de bot칩n: Manual para Fallback
        button.onclick = function() {
            // 1. Mostrar el an치lisis de la URL de anuncio antes de abrirla
            addAdUrlAnalysisToLog(url); 
            
            // 2. Abrir la URL en una nueva pesta침a
            window.open(url, '_blank');
            updateLoadingStatus('REDIRECCI칍N MANUAL', `URL de ${source} abierta.`, true);
            
            // 3. Cancelar el reintento programado si existe
            if (retryTimeout) {
                clearTimeout(retryTimeout);
                retryTimeout = null;
                updateLoadingStatus('RETRY CANCELADO', 'Timeout de reintento autom치tico cancelado.', null);
            }

            // 4. Iniciar inmediatamente un nuevo ciclo de b칰squeda de inventario
            updateLoadingStatus('B칔SQUEDA MANUAL', 'Iniciando una nueva b칰squeda de inventario por acci칩n de usuario.', null);
            adManager._adscoreDeploy(); 
        };

        entry.appendChild(textSpan);
        entry.appendChild(button);

        debugLogElement.insertBefore(entry, debugLogElement.children[1]); 

        loadingMessageElement.textContent = `춰INVENTARIO FALLBACK ENCONTRADO! Presiona el bot칩n para abrir y continuar.`;
    }
    
    // -----------------------------------------------------------
    // FUNCIONES CLAVE DE INVENTARIO
    // -----------------------------------------------------------

    var utils = { 
        _openAd: function(url, options) { updateLoadingStatus('REDIR (Bloqueo)', 'Bloqueada: Se detect칩 un intento de redirecci칩n a: ' + url, true); return true; },
        abortPop: function() { updateLoadingStatus('UTILS', 'Proceso abortado.', false); this.clearUrls(); },
        init: function(config) { this.userActivation = true; this.urls = []; this.settings = {}; this.settings.crtimeout = config.crtimeout || 60 * 1000; this.settings.onbeforeopen = config.onbeforeopen; this.settings.onafteropen = function() { this.adfired = true; updateLoadingStatus('UTILS', 'Ad fired (adfired=true).', true); }.bind(this); this.settings.ignorefailure = config.ignorefailure || false; this.settings.openernull = true; updateLoadingStatus('UTILS', 'Inicializaci칩n completada.', null); },
        clearUrls: function() { this.urls = []; updateLoadingStatus('UTILS', 'URLs de Popads borradas.', null); },
        addUrl: function(url, options) {
            if (!url.match(/^https?:\/\//)) return false;
            this.urls.push({ url: url, options: options });
            updateLoadingStatus('UTILS', 'URL ' + url + ' a침adida a la cola.', null);
            adManager._preparePop(); 
        } 
    };
    var Base64 = { 
        _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
        encode: function(input) { var output = ""; var chr1, chr2, chr3, enc1, enc2, enc3, enc4; var i = 0; input = Base64._utf8_encode(input); while (i < input.length) { chr1 = input.charCodeAt(i++); chr2 = input.charCodeAt(i++); chr3 = input.charCodeAt(i++); enc1 = chr1 >> 2; enc2 = ((chr1 & 3) << 4) | (chr2 >> 4); enc3 = ((chr2 & 15) << 2) | (chr3 >> 6); enc4 = chr3 & 63; if (isNaN(chr2)) { enc3 = enc4 = 64; } else if (isNaN(chr3)) { enc4 = 64; } output = output + this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) + this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4); } return output; }, 
        decode: function(input) { var output = ""; var chr1, chr2, chr3; var enc1, enc2, enc3, enc4; var i = 0; input = input.replace(/[^A-Za-z0-9\+\/\=]/g, ""); while (i < input.length) { enc1 = this._keyStr.indexOf(input.charAt(i++)); enc2 = this._keyStr.indexOf(input.charAt(i++)); enc3 = this._keyStr.indexOf(input.charAt(i++)); enc4 = this._keyStr.indexOf(input.charAt(i++)); chr1 = (enc1 << 2) | (enc2 >> 4); chr2 = ((enc2 & 15) << 4) | (enc3 >> 2); chr3 = ((enc3 & 3) << 6) | enc4; output = output + String.fromCharCode(chr1); if (enc3 !== 64) { output = output + String.fromCharCode(chr2); } if (enc4 !== 64) { output = output + String.fromCharCode(chr3); } } output = Base64._utf8_decode(output); return output; }, 
        _utf8_encode: function(string) { string = string.replace(/\r\n/g, "\n"); var utftext = ""; for (var n = 0; n < string.length; n++) { var c = string.charCodeAt(n); if (c < 128) { utftext += String.fromCharCode(c); } else if ((c > 127) && (c < 2048)) { utftext += String.fromCharCode((c >> 6) | 192); utftext += String.fromCharCode(((c & 63) | 128)); } else { utftext += String.fromCharCode((c >> 12) | 224); utftext += String.fromCharCode(((c >> 6) & 63) | 128); utftext += String.fromCharCode((c & 63) | 128); } } return utftext; }, 
        _utf8_decode: function(utftext) { var string = ""; var i = 0; var c = 0, c1 = 0, c2 = 0; while (i < utftext.length) { c = utftext.charCodeAt(i); if (c < 128) { string += String.fromCharCode(c); i++; } else if ((c > 191) && (c < 224)) { c2 = utftext.charCodeAt(i + 1); string += String.fromCharCode(((c & 31) << 6) | (c2 & 63)); i += 2; } else { c2 = utftext.charCodeAt(i + 1); c3 = utftext.charCodeAt(i + 2); string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63)); i += 3; } } return string; }
    };

    var _pop = _pop || [];
    _pop.push(['siteId', 5226581]);
    _pop.push(['minBid', 0]); // Tu puja m칤nima configurada
    _pop.push(['popundersPerIP', 0]);
    _pop.push(['delayBetween', 0]);
    _pop.push(['default', 'https://t.mbsrv2.com/381468/3788/0?bo=3471,3472,3473,3474,3475&target=domainredirects&po=6456&aff_sub5=SF_006OG000004lmDN']);
    _pop.push(['defaultPerDay', 0]);
    _pop.push(['topmostLayer', false]);
    window._pop = _pop;
    "use strict"; 
    var BASE_PATH = "/c"; 
    var POP_GLOBAL_VAR = "_pop"; 
    var PAO_GLOBAL_VAR = "_pao"; 
    window.Base64 = Base64; 
    var currentScriptElement = document.currentScript; 
    var adscoreTimeout = null; 
    
    var adManager = {
        _inventory: {},
        _config: { 
            _siteId: 0, _minBid: 0, _blockedCountries: false, _default: false, _defaultType: "popunder", _useOverlay: true, _trafficType: 0, _popunderFailover: "tabup", _adscorebp: null, _adscorept: null, 
            _adscoreak: "QpUJAAAAAAAAGu98Hdz1l_lcSZ2rY60Ajjk9U1c" 
        },
        _init: function() {
            var self = this;
            this._loadConfig();
            updateLoadingStatus('MANAGER', 'Configuraci칩n PopAds cargada. SiteID: ' + this._config._siteId, null);
            this.adfired = false;
            utils.init({ prepop: false, catchalldiv: "never", onafteropen: function() { self.adfired = true; } });
            
            if (retryTimeout) {
                clearTimeout(retryTimeout);
                retryTimeout = null;
                updateLoadingStatus('RETRY', 'Ciclo de reintento anterior cancelado.', true);
            }

            this._adscoreDeploy();
        },
        _adscoreDeploy: function() {
            updateLoadingStatus('ADSCORE', 'Iniciando verificaci칩n de Adscore...', null);
            var self = this;
            var adscoreScriptTimeout = 0;
            var config = this._config;
            if (self._config._adscorebp) {
                updateLoadingStatus('ADSCORE', 'Usando firma preestablecida.', true);
                self._checkInventory(self._config._adscorebp);
            } else if (typeof AdscoreInit === "function") {
                try {
                    AdscoreInit(self._config._adscoreak, { 
                        sub_id: config._siteId, 
                        callback: function(result) {
                            var signature = result.signature || "2" + result.error;
                            updateLoadingStatus('ADSCORE', 'Firma Adscore obtenida: ' + signature, true);
                            self._checkInventory(signature); 
                        }
                    });
                } catch (e) { 
                    updateLoadingStatus('ADSCORE', 'Error al llamar a AdscoreInit: ' + e.message, false);
                    self._checkInventory("4" + e.message); 
                }
            } else if (document.body) {
                var domainParts = ["re", "adsco"]; domainParts.push(domainParts[1][3]); var adscoreUrl = "https://" + domainParts.reverse().join(".") + "/"; var script = document.createElement("script"); script.src = adscoreUrl; try { script.onerror = function() { if (script.src === adscoreUrl) { script.src = "https://" + Math.round(Math.pow(52292.244664, 2)) + "/a.js"; } else { clearTimeout(adscoreScriptTimeout); self._checkInventory("1"); } }; } catch (e) {} script.onload = function() { clearTimeout(adscoreScriptTimeout); try { AdscoreInit(self._config._adscoreak, { sub_id: config._siteId, callback: function(result) { self._checkInventory(result.signature || "2" + result.error); } }); } catch (e) { self._checkInventory("4" + e.message); } }; document.body.appendChild(script); adscoreScriptTimeout = setTimeout(function() { self._checkInventory("3"); }, 5000); 
            } else {
                setTimeout(function() { self._adscoreDeploy(); }, 50);
            }
        },
        _checkInventory: function(adscoreSignature) {
            updateLoadingStatus('INVENTORY', 'Paso 1/2: Solicitando inventario al servidor de PopAds...', null);
            this._lastci = (new Date).getTime();
            utils.clearUrls();
            var self = this;
            var intervalId = 0;
            var config = this._config;
            try { clearTimeout(adscoreTimeout); } catch (e) {} adscoreTimeout = setTimeout(function() { self._adscoreDeploy(); }, 300000); 
            intervalId = setInterval(function() {
                var inventoryUrl = "//serve.popads.net" + BASE_PATH;
                if (document.body) {
                    clearInterval(intervalId);
                    var params = {
                        _: encodeURIComponent(adscoreSignature), v: 4, siteId: config._siteId, minBid: config._minBid, blockedCountries: config._blockedCountries || "", documentRef: encodeURIComponent(document.referrer),
                    };
                    for (var key in params) {
                        if (params.hasOwnProperty(key)) { inventoryUrl += (inventoryUrl.indexOf("?") !== -1 ? "&" : "?") + key + "=" + (params[key] || ""); }
                    }
                    var script = document.createElement("script");
                    script.referrerPolicy = "unsafe-url";
                    script.src = inventoryUrl;
                    updateLoadingStatus('INVENTORY', 'Paso 2/2: Esperando respuesta del servidor. URL de solicitud: ' + inventoryUrl, null);
                    try { script.onerror = function() { utils.abortPop(); currentScriptElement.onerror(); }; } catch (e) {}
                    document.body.appendChild(script);
                }
            }, 100);
        },
        
        /**
         * 游띔 FUNCI칍N CLAVE MODIFICADA: L칩gica para abrir la URL principal autom치ticamente, esperar 20s y buscar el siguiente inventario.
         */
        _autoOpenAndSearch: function(url, source, bid) {
            var self = this;
            
            // 1. Log la acci칩n de apertura
            const timestamp = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const truncatedUrl = url.length > 70 ? url.substring(0, 67) + '...' : url;
            
            // Log de apertura
            updateLoadingStatus('URL DETECTADA (AUTO)', `[${source}, Bid: ${bid}] :: ${truncatedUrl}`, true);
            
            // 2. Abre la URL en una nueva pesta침a
            window.open(url, '_blank');
            updateLoadingStatus('AUTO REDIRECCI칍N', `URL de ${source} abierta.`, true);

            // 3. Cancelar cualquier reintento autom치tico pendiente
            if (retryTimeout) {
                clearTimeout(retryTimeout);
                retryTimeout = null;
                updateLoadingStatus('RETRY CANCELADO', 'Timeout de reintento autom치tico cancelado.', null);
            }
            
            // 4. Inicia el temporizador de 20 segundos
            updateLoadingStatus('ESPERA (20s)', `Pr칩xima b칰squeda en ${AUTO_RETRY_DELAY / 1000} segundos. Revise el log y las URLs abiertas.`, null);
            
            retryTimeout = setTimeout(function() {
                // 5. Inicia el nuevo ciclo de b칰squeda despu칠s del retraso
                updateLoadingStatus('B칔SQUEDA AUTOM츼TICA', 'Tiempo de espera agotado. Iniciando nueva b칰squeda de inventario.', null);
                self._adscoreDeploy(); 
            }, AUTO_RETRY_DELAY);
        },

        _parseInventory: function(inventoryData) {
            // 1. CAPTURA DEL JSON COMPLETO
            addJsonResponseToLog(inventoryData); 
            
            this._inventory = inventoryData || {};
            var url = this._inventory.url || '';
            var type = this._inventory.type || 'N/A';
            
            // Ajuste para el BID
            var bid = this._inventory.bid !== undefined ? this._inventory.bid : (this._config._minBid || 'N/A');
            
            if (bid === 0 || bid === '0.0000000000) {
                 bid = 'Min Bid: ' + this._config._minBid;
            } else if (typeof bid === 'number') {
                 bid = bid.toFixed(4);
            }
            
            if (url && url !== "") {
                // 游띔 CASO 1: URL Principal encontrada. Ejecutar ciclo autom치tico (con 20s de espera).
                this._autoOpenAndSearch(url, `Principal (Type: ${type})`, bid);
                
            } else {
                // 游띔 CASO 2: URL Principal NO encontrada (ELSE).
                updateLoadingStatus('PARSE', 'Inventario PRINCIPAL NO encontrado. Iniciando Fallback/Reintento.', false);
                
                // 2. Iniciar el reintento autom치tico (si el usuario no interact칰a)
                this._preparePopDefault(); 
                
                // 3. URL DEFAULT (Fallback, si est치 configurada) - Mantiene el bot칩n de acci칩n manual.
                const defaultUrl = this._config._default;
                if (defaultUrl) {
                    addRedirectButtonToLog('Default (Fallback)', defaultUrl, 'Min Bid: ' + this._config._minBid);
                }
            }
        }, 
        _preparePopDefault: function() {
            updateLoadingStatus('SIN INVENTARIO', 'No se encontr칩 Inventario Principal. Reintentando b칰squeda en ' + (RETRY_INTERVAL / 1000) + ' segundos...', false);
            
            // Si el usuario no act칰a, el reintento autom치tico sigue funcionando
            retryTimeout = setTimeout(function() {
                updateLoadingStatus('RETRY', 'Tiempo de espera agotado (' + (RETRY_INTERVAL / 1000) + 's). Reintentando b칰squeda de inventario.', null);
                adManager._adscoreDeploy(); 
            }, RETRY_INTERVAL);
        },
        _waitForGoodWeather: function() {
            setTimeout(this._init.bind(this), 0);
        },
        _loadConfig: function() {
            var globalConfig = window[POP_GLOBAL_VAR] || [];
            var config = this._config;
            for (var i = 0; i < globalConfig.length; i++) {
                var key = globalConfig[i][0];
                var value = globalConfig[i][1];
                switch (key) { case "siteId": case "delayBetween": case "defaultPerIP": case "trafficType": value = parseInt(value, 10); if (isNaN(value)) continue; }
                switch (key) {
                    case "siteId": config._siteId = value; break;
                    case "minBid": config._minBid = parseFloat(value); break; 
                    case "blockedCountries": config._blockedCountries = value; break;
                    case "default": config._default = value; break;
                    case "defaultType": config._defaultType = value; break;
                    case "topmostLayer": config._useOverlay = value; break;
                    case "trafficType": config._trafficType = value; break;
                    case "popunderFailover": config._popunderFailover = value; break;
                    case "prepop": break;
                    case "adscorebp": config._adscorebp = value; break;
                    case "adscorept": config._adscorept = value; break;
                    case "adscoreak": config._adscoreak = value; break;
                }
            }
            updateLoadingStatus('CONFIG', 'Configuraci칩n de _pop[] procesada.', null);
        }
    };
    
    for (var prop in window) { try { if (prop.match(/[0-9a-f]{32,32}/) && window[prop] && window[prop].length >= 7 && window[prop][0] && window[prop][0][0] && !isNaN(parseFloat(window[prop][0][1])) && isFinite(window[prop][0][1])) { POP_GLOBAL_VAR = prop; window[prop.slice(0, 16) + prop.slice(0, 16)] = window[prop]; break; } } catch (e) {} } 
    if (!"//serve.popads.net".includes(".net")) { 
        PAO_GLOBAL_VAR = ""; 
        var randomLength = 10 + Math.floor(10 * Math.random()); 
        for (var i = 0; i < randomLength; i++) { PAO_GLOBAL_VAR += "abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(26 * Math.random())); } 
        BASE_PATH = "/" + PAO_GLOBAL_VAR; 
    } 
    
    // API P칔BLICA (Maneja las respuestas del servidor)
    var publicApi = {
        parse: function(inventoryData) { adManager._parseInventory(inventoryData); },
        fbparse: function(bannerData) { 
            var bid = bannerData.bid !== undefined ? bannerData.bid : 'N/A';
            if (bannerData.url) {
                 // El banner de fallback tambi칠n activa el ciclo autom치tico, con el retraso de 20s.
                 adManager._autoOpenAndSearch(bannerData.url, `Fallback Banner (Type: Banner)`, bid);
            }
            utils._openAd(bannerData.url, {}); 
        },
    };
    try { window._pao = publicApi; Object.freeze(window._pao); } catch (e) {}
    try { window[PAO_GLOBAL_VAR] = publicApi; Object.freeze(window[PAO_GLOBAL_VAR]); } catch (e) {}
    
    // Iniciar el proceso
    adManager._waitForGoodWeather();
})(window, window.document, window.screen);
</script>
</body>
</html>
